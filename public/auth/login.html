<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>login - coffeeroom</title>
    <meta name="theme-color" content="#d8e3ed" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#242931" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <script defer src="/scripts/favicon.js"></script>
    <link rel="stylesheet" href="/css/auth.css">
    <script>
      (function() {
          const savedMode = localStorage.getItem('theme-mode') || 'auto';
          let isDark = false;
          let isMono = false;
          if (savedMode === 'auto') {
              isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          } else if (savedMode === 'mono') {
              isMono = true;
          } else {
              isDark = (savedMode === 'dark');
          }
          if (isDark) {
              document.documentElement.setAttribute('data-theme', 'dark');
          } else if (isMono) {
              document.documentElement.setAttribute('data-theme', 'mono');
          }
      })();
    </script>
    <script defer src="https://cloud.umami.is/script.js" data-website-id="cf3f6b51-a212-4d89-bad2-8d83e259075d"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <script>
      (async function() {
        try {
          const res = await fetch('/api/user');
          if (res.ok) {
            window.location.href = '/';
          }
        } catch (e) {}
      })();
    </script>
  </head>
  <body>
    <div class="box">
        <div class="content">
          <div class="header">  
          <span class="title">caffeineId</span>
          <span class="themebtn">theme: <a href="#" id="darkModeButton">auto</a></span>
          </div>
          <br>
          <div class="title-auth">Login</div>
          <div class="container">
            <div class="authbox">
                <span class="text">Welcome back!</span>
            </div>
            <!-- Login Box -->
            <div class="authbox" id="login-box">
                <div id="auth-message" class="auth-message"></div>
                <br>
                <!-- Login Form -->
                <form id="login-form">
                    <div class="input-group"><input type="text" id="username" name="username" placeholder="username" required /></div>
                    <div class="input-group"><input type="password" id="password" name="password" placeholder="password" required /></div>
                    <div class="input-group"><div class="cf-turnstile" data-sitekey="0x4AAAAAACJid3sBnLLYO4zB"></div></div>
                    <button type="submit">login</button>
                </form>
                <br>
            </div>

            <!-- 2FA Box -->
            <div class="authbox" id="2fa-box" style="display: none;">
                <div id="auth-message-2fa" class="auth-message"></div>
                <br>
                <form id="2fa-form">
                    <div class="text" style="margin-bottom: 10px;">Please enter your 2FA code</div>
                    <div class="input-group">
                        <input type="text" id="2fa-code" name="code" placeholder="000000" required autocomplete="off" />
                    </div>
                    <button type="submit">verify</button>
                </form>
                <br>
            </div>

            <!-- Recovery Code Box -->
            <div class="authbox" id="recover-box" style="display: none;">
                <div id="auth-message-recover" class="auth-message"></div>
                <br>
                <form id="recover-form">
                    <div class="text" style="margin-bottom: 10px;">Enter recovery code</div>
                    <div class="input-group">
                        <input type="text" id="recover-code" name="code" placeholder="xxxxx-xxxxx" required autocomplete="off" />
                    </div>
                    <button type="submit">verify</button>
                </form>
                <br>
            </div>
            <div class="authbox" id="bottom-box-default">
                <span class="text">Don't have an account? Let's <a href="/auth/signup.html">sign up</a>. </span><br><span class="text">Or login with your <a href="/auth/tokens.html">tokens</a>. <a href="/auth/forgot.html">Forgot password?</a></span><br>
            </div>

            <div class="authbox" id="bottom-box-2fa" style="display: none;">
                <div style="display: flex; justify-content: space-between; padding: 5px; width: 100%; box-sizing: border-box;">
                    <a href="#" onclick="location.reload(); return false;" style="font-size: 14px;">&lt; return</a>
                    <a href="#" id="toggle-auth-method" style="font-size: 14px;">use recovery code</a>
                </div>
            </div>
          </div>
          <br>
        </div>
        <br>
        <footer>
          <span class="copyright">Copyright (c) 2025-2026 caffeine-Ink. Licensed under AGPLv3. <span class="app-ver"></span></span>
        </footer>
    </div>
    <script src="/scripts/theme.js"></script>
    <script>
      const loginBox = document.getElementById('login-box');
      const twoFaBox = document.getElementById('2fa-box');
      const recoverBox = document.getElementById('recover-box');
      
      const loginForm = document.getElementById('login-form');
      const twoFaForm = document.getElementById('2fa-form');
      const recoverForm = document.getElementById('recover-form');
      
      const msgBoxLogin = document.getElementById('auth-message');
      const msgBox2Fa = document.getElementById('auth-message-2fa');
      const msgBoxRecover = document.getElementById('auth-message-recover');
      
      const bottomBoxDefault = document.getElementById('bottom-box-default');
      const bottomBox2Fa = document.getElementById('bottom-box-2fa');
      const toggleAuthMethod = document.getElementById('toggle-auth-method');
      
      let tempToken = null;

      function showMessage(msg, type = 'error') {
          // Determine which box is active
          let activeMsgBox = msgBoxLogin;
          if (twoFaBox.style.display !== 'none') {
              activeMsgBox = msgBox2Fa;
          } else if (recoverBox.style.display !== 'none') {
              activeMsgBox = msgBoxRecover;
          }

          activeMsgBox.innerText = msg;
          activeMsgBox.className = `auth-message ${type}`;
          activeMsgBox.style.display = 'block';
      }

      function hideMessage() {
          msgBoxLogin.style.display = 'none';
          msgBox2Fa.style.display = 'none';
          msgBoxRecover.style.display = 'none';
      }

      function setupValidation(form) {
          form.querySelectorAll('input').forEach(input => {
              input.addEventListener('invalid', function(e) {
                  e.preventDefault();
                  const oldTip = this.parentNode.querySelector('.error-tip');
                  if (oldTip) oldTip.remove();
                  const tip = document.createElement('div');
                  tip.className = 'error-tip';
                  tip.innerText = this.validationMessage;
                  this.parentNode.appendChild(tip);
                  setTimeout(() => { tip.remove(); }, 2000);
              });
          });
      }
      setupValidation(loginForm);
      setupValidation(twoFaForm);
      setupValidation(recoverForm);

      // Toggle Logic
      toggleAuthMethod.addEventListener('click', (e) => {
          e.preventDefault();
          hideMessage();
          
          if (twoFaBox.style.display !== 'none') {
              twoFaBox.style.display = 'none';
              recoverBox.style.display = 'block';
              toggleAuthMethod.innerText = "use 2FA code";
          } else {
              recoverBox.style.display = 'none';
              twoFaBox.style.display = 'block';
              toggleAuthMethod.innerText = "use recovery code";
          }
      });

      // 1. Login Submit
      loginForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          hideMessage();

          const formData = new FormData(loginForm);

          try {
              const res = await fetch('/api/login', {
                  method: 'POST',
                  body: formData
              });
              const data = await res.json();

              if (data.success) {
                  if (data['2fa_required']) {
                      tempToken = data.temp_token;
                      loginBox.style.display = 'none';
                      twoFaBox.style.display = 'block';
                      bottomBoxDefault.style.display = 'none';
                      bottomBox2Fa.style.display = 'flex';
                  } else {
                      showMessage(data.message, "success");
                      setTimeout(() => { window.location.href = '/'; }, 2000);
                  }
              } else {
                  showMessage(data.message, "error");
                  if (window.turnstile) turnstile.reset();
              }
          } catch (err) {
              showMessage("network error", "error");
          }
      });

      // Helper for 2FA/Recovery Submit
      async function submitCode(code, type) {
          hideMessage();
          const formData = new FormData();
          formData.append('temp_token', tempToken);
          formData.append('code', code);
          formData.append('type', type);

          try {
              const res = await fetch('/api/login/2fa', {
                  method: 'POST',
                  body: formData
              });
              const data = await res.json();

              if (data.success) {
                  showMessage(data.message, "success");
                  setTimeout(() => { window.location.href = '/'; }, 2000);
              } else {
                  showMessage(data.message, "error");
              }
          } catch (err) {
              showMessage("network error", "error");
          }
      }

      // 2. 2FA Submit
      twoFaForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          const code = document.getElementById('2fa-code').value;
          await submitCode(code, 'totp');
      });

      // 3. Recovery Submit
      recoverForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          const code = document.getElementById('recover-code').value;
          await submitCode(code, 'recovery');
      });
    </script>
    <script src="/scripts/version.js"></script>
  </body>
</html>