<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>profile - cafe1chaT</title>
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="/css/style.css">
    <script>
      (function() {
          const savedMode = localStorage.getItem('theme-mode') || 'auto';
          let isDark = false;
          let isMono = false;
          if (savedMode === 'auto') {
              isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          } else if (savedMode === 'mono') {
              isMono = true;
          } else {
              isDark = (savedMode === 'dark');
          }
          if (isDark) {
              document.documentElement.setAttribute('data-theme', 'dark');
          } else if (isMono) {
              document.documentElement.setAttribute('data-theme', 'mono');
          }
      })();
    </script>
	<script defer src="https://cloud.umami.is/script.js" data-website-id="cf3f6b51-a212-4d89-bad2-8d83e259075d"></script>
    <style>
        .profile-table {
            width: 100%;
            max-width: 400px;
            border-collapse: collapse;
            font-family: 'unifont', sans-serif;
        }
        .profile-table td {
            padding: 8px 0;
        }
        .profile-table td:first-child {
            width: 120px;
            color: var(--border-color);
        }
        .loading-text {
            color: var(--border-color);
        }

        #profile-content {
            border : 1px solid var(--border-color);
            background-color: var(--chat-bg-color);
            border-radius: 5px;
            padding: 15px;
            display: block;
            max-width: 450px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 20px;
        }
    </style>
  </head>
  <body>
    <div class="box">
        <div class="content">
          <div class="header">
            <span class="title">cafe1chaT</span>
            <span class="themebtn">
              <span id="user-display">loading...</span>
              theme: <a href="#" id="darkModeButton">auto</a>
            </span>
          </div>
          
          <div class="title" style="margin: 30px 0; font-size: 18px;">User Profile</div>
          
          <div id="profile-content">
              <table class="profile-table">
                  <tr>
                      <td>uid</td>
                      <td id="p-uid" class="loading-text">...</td>
                  </tr>
                  <tr>
                      <td>username</td>
                      <td id="p-username" class="loading-text">...</td>
                  </tr>
                  <tr>
                      <td>role</td>
                      <td id="p-role" class="loading-text">...</td>
                  </tr>
                  <tr>
                      <td>joined</td>
                      <td id="p-date" class="loading-text">...</td>
                  </tr>
              </table>
          </div>

          <br>
          <div style="font-family: 'unifont'; font-size: 14px;"><a href="/">&lt; back to chat</a></div>
        </div>
        <br>
        <footer>
          <span class="copyright">Copyright (c) 2025 <a href="https://caffeine.ink" target="_blank" rel="noopener noreferrer">caffeine-Ink</a>. Licensed under <a href="https://caffeine.ink/pages/agpl-3.0-standalone.html" target="_blank" rel="noopener noreferrer">AGPLv3</a>.</span> <span class="version">v1.0 (<a href="https://github.com/khangaiNgaan/chatroom" target="_blank" rel="noopener noreferrer">source code</a>)</span>
        </footer>
    </div>
    
    <script src="/scripts/theme.js"></script>
    <script defer src="/scripts/favicon.js"></script>
    <script>
    // 辅助函数: 格式化时间戳
    function formatDate(timestamp) {
        if (!timestamp) return 'Unknown';
        const date = new Date(timestamp);
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const h = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        const s = String(date.getSeconds()).padStart(2, '0');
        return `${y}-${m}-${d} ${h}:${min}:${s}`;
    }

    (async function() {
        const userDisplay = document.getElementById('user-display');
        const pUid = document.getElementById('p-uid');
        const pUsername = document.getElementById('p-username');
        const pRole = document.getElementById('p-role');
        const pDate = document.getElementById('p-date');

        try {
            const res = await fetch('/api/user');
            
            if (res.status === 401) {
                // 未登录，跳转
                window.location.href = '/login.html';
                return;
            }

            if (res.ok) {
                const user = await res.json();
                
                // 填充 Header
                userDisplay.innerHTML = `Hi, ${user.username} (<a href="/api/logout">logout</a>) `;
                
                // 填充表格
                pUid.innerText = user.uid || '-';
                pUid.classList.remove('loading-text');

                pUsername.innerText = user.username || '-';
                pUsername.classList.remove('loading-text');

                pRole.innerText = user.role || 'user';
                pRole.classList.remove('loading-text');

                pDate.innerText = formatDate(user.signup_date);
                pDate.classList.remove('loading-text');
            }
        } catch (e) {
            console.error(e);
            userDisplay.innerText = "Error loading profile";
        }
    })();
    </script>
  </body>
</html>
  