<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sign up - coffeeroom</title>
    <meta name="theme-color" content="#d8e3ed" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#242931" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <script defer src="/scripts/favicon.js"></script>
    <link rel="stylesheet" href="/css/auth.css">
    <script src="/scripts/os_detect.js"></script>
    <script>
      (function() {
          const savedMode = localStorage.getItem('theme-mode') || 'auto';
          let isDark = false;
          let isMono = false;
          if (savedMode === 'auto') {
              isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          } else if (savedMode === 'mono') {
              isMono = true;
          } else {
              isDark = (savedMode === 'dark');
          }
          if (isDark) {
              document.documentElement.setAttribute('data-theme', 'dark');
          } else if (isMono) {
              document.documentElement.setAttribute('data-theme', 'mono');
          }
      })();
    </script>
    <script defer src="https://cloud.umami.is/script.js" data-website-id="cf3f6b51-a212-4d89-bad2-8d83e259075d"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <script>
      (async function() {
        try {
          const res = await fetch('/api/user');
          if (res.ok) {
            window.location.href = '/';
          }
        } catch (e) {}
      })();
    </script>
  </head>
  <body>
    <div class="box">
        <div class="content">
          <div class="header">  
          <span class="title">caffeineId</span>
          <span class="themebtn">theme: <a href="#" id="darkModeButton">auto</a></span>
          </div>
          <br>
          <div class="title-auth">Sign Up</div>
          <div class="container">
            <div class="authbox">
                <span class="text">Welcome to <a href="https://caffeine.ink" target="_blank" rel="noopener noreferrer" style="text-decoration: none;">caffeine-Ink</a>!</span>
            </div>
            <div class="authbox">
                <div id="auth-message" class="auth-message"></div>
                <br>
                <form id="login-form" method="POST" action="/api/signup">
                    <div class="input-group"><input type="text" id="username" name="username" placeholder="username" required /></div>
                    <div class="input-group"><input type="password" id="password" name="password" placeholder="password" required /></div>
                    <div class="input-group"><input type="password" id="confirm-password" name="confirm-password" placeholder="confirm password" required /></div>
                    <button type="submit">continue</button>
                </form>
                <br>
            </div>
            <div class="authbox">
                <span class="text">Already have an account? Go to <a href="/auth/login.html">login</a>.</span>
            </div>
          </div>
          <br>
        </div>
        <br>
        <footer>
          <span class="copyright">Copyright (c) 2025-2026 caffeine-Ink. Licensed under AGPLv3. <span class="app-ver"></span></span>
        </footer>
    </div>
    <script src="/scripts/theme.js"></script>
    <script>
      const form = document.getElementById('login-form');
      const msgBox = document.getElementById('auth-message');

      form.querySelectorAll('input').forEach(input => {
          input.addEventListener('invalid', function(e) {
              e.preventDefault();
              const tip = document.createElement('div');
              tip.className = 'error-tip';
              tip.innerText = this.validationMessage;
              this.parentNode.appendChild(tip);
              setTimeout(() => { tip.remove(); }, 2000);
          });
      });

      // 第一步：验证并跳转
      form.addEventListener('submit', async function(e) {
          e.preventDefault();
          msgBox.style.display = 'none';
          msgBox.className = 'auth-message';

          const formData = new FormData(form);
          const password = formData.get('password');
          const confirmPassword = formData.get('confirm-password');

          if (password.length < 6) {
              msgBox.innerText = "password must be at least 6 characters";
              msgBox.style.display = 'block';
              msgBox.classList.add('error');
              return;
          }

          if (password !== confirmPassword) {
              msgBox.innerText = "passwords do not match";
              msgBox.style.display = 'block';
              msgBox.classList.add('error');
              return;
          }

          // 这里可以加简单的前端格式校验，但最终以第二步后端校验为准
          // 为了不暴露 API，我们直接存入 session 并跳转
          // 或者先发个请求验证用户名是否可用？ (建议)

          try {
              const res = await fetch('/api/signup/check-username', {
                  method: 'POST',
                  body: formData
              });
              
              const data = await res.json();

              if (data.success) {
                  // 存储数据
                  sessionStorage.setItem('signup_username', formData.get('username'));
                  sessionStorage.setItem('signup_password', password);
                  // 跳转第二步
                  window.location.href = '/auth/signup_verify.html';
              } else {
                  msgBox.innerText = data.message;
                  msgBox.style.display = 'block';
                  msgBox.classList.add('error');
              }
          } catch (err) {
              msgBox.innerText = "network error";
              msgBox.style.display = 'block';
              msgBox.classList.add('error');
          }
      });
    </script>
    <script src="/scripts/version.js"></script>
  </body>
</html>