<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>access tokens - cafe1chaT</title>
    <meta name="theme-color" content="#d8e3ed" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#242931" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/style.css">
    <script>
      (function() {
          const savedMode = localStorage.getItem('theme-mode') || 'auto';
          let isDark = false;
          let isMono = false;
          if (savedMode === 'auto') {
              isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          } else if (savedMode === 'mono') {
              isMono = true;
          } else {
              isDark = (savedMode === 'dark');
          }
          if (isDark) {
              document.documentElement.setAttribute('data-theme', 'dark');
          } else if (isMono) {
              document.documentElement.setAttribute('data-theme', 'mono');
          }
      })();
    </script>
    <style>
        .token-item {
            border: 1px solid var(--border-color);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 3px;
            background: var(--chat-bg-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
        }
        .token-info {
            text-align: left;
        }
        .token-label {
            font-family: 'unifont', sans-serif;
            font-size: 14px;
            font-weight: bold;
            display: block;
        }
        .token-mask {
            font-family: 'unifont', monospace;
            color: var(--border-color);
            font-size: 12px;
        }
        .btn-delete {
            color: var(--connection-red);
            border: 1px solid var(--border-color);
            background: transparent;
            padding: 2px 10px 3px 10px;
            cursor: pointer;
            height: 23px;
            font-size: 0.8em;
            border-radius: 3px;
            width: 70px;
        }
        .btn-delete:hover {
            background: var(--connection-red);
            color: var(--button-color);
            border-color: var(--connection-red);
        }
        .btn-delete:active {
            background: var(--button-color);
            color: var(--connection-red);
            border-color: var(--connection-red);
        }
        
        /* New Token Display */
        #new-token-display {
            display: none;
            background: var(--chat-bg-color);
            border: 1px solid var(--border-color);
            padding: 10px;
            width: 100%;
            margin-bottom: 10px;
            border-radius: 3px;
        }
        .display-container {
            max-width: 450px;
            display: flex;
            box-sizing: border-box;
        }
        #tokens-list {
            width: 100%;
        }

        .token-secret {
            font-family: 'unifont', monospace;
            font-size: 14px;
            word-break: break-all;
            margin: 5px 0;
            padding: 5px;
            user-select: all;
            background-color: var(--msg-bg-color);
            border-radius: 3px;
        }
        .warning-text {
            color: var(--text-color);
            font-family: 'unifont', sans-serif;
            font-size: 12px;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .create-form {
            margin-bottom: 20px;
            display: flex;
            gap: 5px;
            max-width: 450px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .input-group {
            position: relative;
            display: block;
            width: 100%;
        }

        .create-form input {
            font-family: 'unifont', sans-serif;
            font-size: 14px;
            color: var(--text-color);
            background-color: var(--chat-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            width: 100%;
            padding: 3px 5px;
            min-width: 0;
            height: 23px;
            box-sizing: border-box;
        }

        .create-form button {
            font-family: 'unifont', sans-serif;
            font-size: 14px;
            width: 80px;
            color: var(--text-color);
            background-color: var(--button-color);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            height: 23px;
            padding: 0 10px 2px 10px;
            box-sizing: border-box;
            cursor: pointer;
        }

        .alert {
            font-family: 'unifont', sans-serif;
            font-size: 14px;
            color: var(--border-color);
        }
        
        input:focus {
            outline: 1px solid var(--text-color);
        }
        button:hover {
            background-color: var(--button-hover-color);
        }

        button:active {
            background-color: var(--button-active-color);
        }

        .button-group {
            margin-top: 10px;
            display: flex;
            justify-content: right;
            gap: 5px;
        }
        .button-group button {
            width: 60px;
            height: 21px;
            margin-left: 0;
            padding: 0 10px 2px 10px;
            box-sizing: border-box;
            cursor: pointer;
        }
        
        /* Error tooltip */
        .error-tip {
            position: absolute;
            top: 110%;
            left: 0;
            font-family: 'unifont', sans-serif;
            color: var(--text-color);
            background-color: var(--popup-bg-color); /* Light mode default */
            backdrop-filter: blur(2px);
            --webkit-backdrop-filter: blur(2px);
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
            pointer-events: none;
        }
    </style>
  </head>
  <body>
    <div class="box">
        <div class="content">
          <div class="header">
            <span class="title">cafe1chaT</span>
            <span class="themebtn">
              <span id="user-display">loading...</span>
              theme: <a href="#" id="darkModeButton">auto</a>
            </span>
          </div>
          
          <div class="title" style="margin: 30px 0; font-size: 18px;">Access Tokens</div>
          
          <form id="create-token-form" class="create-form">
                <div class="input-group"><input type="text" name="label" placeholder="token label" required maxlength="30"></div><button type="submit">generate</button>
          </form>

          <div class="display-container">
            <div id="new-token-display">
                <div style="font-family: 'unifont', sans-serif; color: var(--connection-green); font-size: 14px; margin-bottom: 15px; text-align: center;">Access Token Created</div>
                <div class="token-secret" id="token-secret-text" style="text-align: center;"></div>
                <div class="warning-text">Copy it now. It won't be shown again.</div>
                <div class="button-group"><button id="copy-token-button">copy</button><button id="close-token-button">close</button></div>
            </div>
          </div>

          <div class="display-container">
            <div id="tokens-list">
                <div class="alert">loading...</div>
            </div>
          </div>

          <br>
          <div class="back"><a href="/user/profile.html">&lt; back to profile</a></div>
        </div>
        <footer>
          <span class="copyright">Copyright (c) 2025-2026 <a href="https://caffeine.ink" target="_blank" rel="noopener noreferrer">caffeine-Ink</a>. Licensed under <a href="https://caffeine.ink/pages/agpl-3.0-standalone.html" target="_blank" rel="noopener noreferrer">AGPLv3</a>.</span>
          <span class="version"><span class="app-ver"></span> (<a href="https://github.com/khangaiNgaan/chatroom" target="_blank" rel="noopener noreferrer">source code</a>)</span>
        </footer>
    </div>
    
    <script src="/scripts/theme.js"></script>
    <script defer src="/scripts/favicon.js"></script>
    <script>
    // Utils
    function formatDate(timestamp) {
        const date = new Date(timestamp);
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const h = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        const s = String(date.getSeconds()).padStart(2, '0');
        return `${y}-${m}-${d} ${h}:${min}:${s}`;
    }

    // Main
    (async function() {
        const userDisplay = document.getElementById('user-display');
        const listDiv = document.getElementById('tokens-list');
        const createForm = document.getElementById('create-token-form');
        const newTokenDisplay = document.getElementById('new-token-display');
        const tokenSecretText = document.getElementById('token-secret-text');
        const copyBtn = document.getElementById('copy-token-button');
        const closeBtn = document.getElementById('close-token-button');

        // 0. Button Listeners
        copyBtn.addEventListener('click', () => {
            const text = tokenSecretText.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'done';
                setTimeout(() => { copyBtn.textContent = originalText; }, 2000);
            });
        });

        closeBtn.addEventListener('click', () => {
            newTokenDisplay.style.display = 'none';
        });

        // 1. Auth Check
        try {
            const res = await fetch('/api/user');
            if (res.status === 401) {
                window.location.href = '/auth/login.html';
                return;
            }
            if (res.ok) {
                const user = await res.json();
                userDisplay.innerHTML = `Hi, ${user.username} (<a href="/api/logout">logout</a>) `;
                loadTokens();
            }
        } catch (e) {
            console.error(e);
            userDisplay.innerText = "error loading profile";
        }

        createForm.querySelectorAll('input').forEach(input => {
            input.addEventListener('invalid', function(e) {
                e.preventDefault();
                const tip = document.createElement('div');
                tip.className = 'error-tip';
                tip.innerText = this.validationMessage;
                this.parentNode.appendChild(tip);
                setTimeout(() => { tip.remove(); }, 2000);
            });
        });

        // 2. Load Tokens
        async function loadTokens() {
            try {
                const res = await fetch('/api/tokens');
                const data = await res.json();
                
                if (data.success) {
                    renderList(data.tokens);
                } else {
                    listDiv.innerHTML = `<div class="alert" style="color: var(--connection-red);">Error: ${data.message}</div>`;
                }
            } catch (e) {
                listDiv.innerHTML = `<div class="alert" style="color: var(--connection-red);">Network error</div>`;
            }
        }

        // 3. Render List
        function renderList(tokens) {
            if (tokens.length === 0) {
                listDiv.innerHTML = `<div class="alert">No active tokens</div>`;
                return;
            }

            listDiv.innerHTML = '';
            tokens.forEach(t => {
                const div = document.createElement('div');
                div.className = 'token-item';
                
                div.innerHTML = `
                    <div class="token-info">
                        <span class="token-label">${escapeHtml(t.label || 'Unnamed')}</span>
                        <span class="token-mask">${formatDate(t.created_at)}</span>
                    </div>
                    <button class="btn-delete" data-id="${t.id}">delete</button>
                `;
                
                // Bind delete event
                div.querySelector('.btn-delete').addEventListener('click', () => deleteToken(t.id));
                listDiv.appendChild(div);
            });
        }

        // 4. Create Token
        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(createForm);
            
            try {
                const res = await fetch('/api/tokens', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (data.success) {
                    // Show secret
                    tokenSecretText.textContent = data.token;
                    newTokenDisplay.style.display = 'block';
                    createForm.reset();
                    // Reload list
                    loadTokens();
                } else {
                    alert("Failed: " + data.message);
                }
            } catch (e) {
                alert("Network error");
            }
        });

        // 5. Delete Token
        async function deleteToken(id) {
            if (!confirm("Are you sure you want to delete this token? This action cannot be undone.")) return;
            
            try {
                const res = await fetch(`/api/tokens?id=${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    loadTokens();
                } else {
                    alert("Delete failed: " + data.message);
                }
            } catch (e) {
                alert("Network error");
            }
        }

        function escapeHtml(text) {
          if (!text) return text;
          return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

    })();
    </script>
    <script src="/scripts/version.js"></script>
  </body>
</html>